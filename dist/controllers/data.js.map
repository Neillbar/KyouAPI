{"version":3,"sources":["../../src/controllers/data.js"],"names":["mongoose","require","Router","image2base64","attachmentSchema","complaintSchema","fs","module","exports","config","db","api","post","req","res","decodedFile","Buffer","from","body","image","indexOf","split","name","writeFile","err","written","console","log","findOne","complaintID","FindComplaint","status","send","complaintsID","checker","newAtt","type","decodedImage","push","decodedRecording","recording","video","save","newentry","updated","get","find","params","findAttachment","length","allData","i","items","toString","convertBase64ToString","object"],"mappings":"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","file":"data.js","sourcesContent":["var mongoose = require('mongoose');\nvar {Router} = require('express');\nconst image2base64 = require('image-to-base64');\nvar attachmentSchema = require('../Schemas/attachmentsSchema');\nvar complaintSchema = require('../Schemas/complaintsSchema');\nconst fs = require('fs');\n\nmodule.exports = ({config,db}) => {\n\n    let api = Router();\n\n\n    api.post('/viaFilesystem',async (req,res) => {\n        let decodedFile = Buffer.from(req.body.image.indexOf('base64') !== -1 ? req.body.image.split('base64,')[1] : req.body.image, 'base64');\n        name = req.body.name;\n        fs.writeFile(`./images/${name}`, decodedFile, function(err,written){\n        if(err) console.log(err);\n         else {\n          console.log(\"Successfully written\");\n         }\n     });\n\n    })\n\n\n\n\napi.post('/attachment',async (req,res) => {\n\nlet FindComplaint = await complaintSchema.findOne({complaintID: req.body.complaintID});\n\nif(!FindComplaint){\n    return res.status(400).send(\"No complaints found can't add attachments\");\n}\n\n\n\n// //take base64 to Buffer\n\n\n\n    \n\nlet checker = await attachmentSchema.findOne({complaintsID: req.body.complaintID});\n\nif(!checker){\n    var newAtt = new attachmentSchema();\n    newAtt.complaintsID = req.body.complaintID;\n    \n    if (req.body.type == \"image\"){\n        let decodedImage = Buffer.from(req.body.image.indexOf('base64') !== -1 ? req.body.image.split('base64,')[1] : req.body.image, 'base64');\n        newAtt.image.push(decodedImage);\n    }\n    \n    if(req.body.type == \"recording\"){\n    \n        let decodedRecording = Buffer.from(req.body.recording.indexOf('base64') !== -1 ? req.body.recording.split('base64,')[1] : req.body.recording, 'base64');\n        newAtt.recording = decodedRecording;\n    }\n    if(req.body.type == \"video\"){\n    \n        let decodedRecording = Buffer.from(req.body.video.indexOf('base64') !== -1 ? req.body.video.split('base64,')[1] : req.body.video, 'base64');\n        newAtt.video = decodedRecording;\n    }\n    \n    \n    let newentry = await newAtt.save();\n    if(newentry){\n        res.send(newentry);\n    }\n    \n}else{\n\n    if (req.body.type == \"image\"){\n        let decodedImage = Buffer.from(req.body.image.indexOf('base64') !== -1 ? req.body.image.split('base64,')[1] : req.body.image, 'base64');\n        checker.image.push(decodedImage);\n    }\n    \n    if(req.body.type == \"recording\"){\n    \n        let decodedRecording = Buffer.from(req.body.recording.indexOf('base64') !== -1 ? req.body.recording.split('base64,')[1] : req.body.recording, 'base64');\n        checker.recording = decodedRecording;\n    }\n    if(req.body.type == \"video\"){\n    \n        let decodedRecording = Buffer.from(req.body.video.indexOf('base64') !== -1 ? req.body.video.split('base64,')[1] : req.body.video, 'base64');\n        newAtt.video = decodedRecording;\n    }\n\nlet updated = await checker.save();\nif(updated){\n    res.send(updated);\n}\n\n\n}\n\n\n\n//take Buffer back to base64\n\n//let text = decodedFile.toString('base64')\n\n     //let subStr = req.body.image.indexOf('data/')\n    // let newSubstr = req.body.image.indexOf('base64')\n    // let tell = req.body.image;\n    // let imageType = tell.substring(subStr+6, newSubstr)\n\n   // console.log(subStr);\n    // console.log(tell);\n    // console.log(tell);\n    // console.log(imageType);\n\n\n//take base64 to a file! \n    // fs.writeFile('test.png', decodedFile, function(err,written){\n    //     if(err) console.log(err);\n    //      else {\n    //       console.log(\"Successfully written\");\n    //      }\n    //  });\n\n    // take file back to base64\n//let file = image2base64('./test.png');\n\n//console.log(await file);\n\n})\n\napi.get('/getByName/:name', async (req,res) => {\n\n    let findAttachment = await attachmentSchema.find({name:req.params.name});\n\n    if(findAttachment.length < 1){\n\n        return res.status(400).send(\"Could not find attachments\");\n    }\n\n\n\nlet allData = [];\nvar i = 0;\n//console.log(findAttachment[0].image.length);\nfor(var items in  findAttachment[0].image){\n    \n    let name = findAttachment[0].name;\n   \n   let convertBase64ToString = await findAttachment[0].image[items].toString('base64');\n\nlet object = {name:name,image:convertBase64ToString };\nallData.push(object);\n}\n//console.log(allData[0]);\n\n//console.log(findAttachment[0].image[1].toString('base64'));\n\nreturn res.send(allData);\n\n\n\n})\n\n    return api;\n\n}"]}